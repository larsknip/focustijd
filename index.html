<!DOCTYPE html>
<html>
  <head>
    <title>Test</title>
    <style>
      body {
        background-color: black;
        font-family: Arial, sans-serif;
        text-align: center;
      }
      h1 {
        color: white;
        font-size: 48px;
        margin-top: 100px;
      }
      .btn {
        background-color: #1db954;
        color: white;
        padding: 16px 32px;
        border: none;
        border-radius: 4px;
        font-size: 24px;
        cursor: pointer;
        margin-top: 50px;
      }
      .btn:hover {
        background-color: #1ed760;
      }
      .slideshow {
        margin-top: 20px;
        position: relative;
        width: 500px;
        height: 500px;
        overflow: hidden;
      }
      .slideshow img {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: opacity 1s ease-in-out;
        opacity: 0;
      }
      .slideshow img.active {
        opacity: 1;
      }
    </style>
  </head>
  <body>
    <h1>Albums om te concentreren</h1>

    <div class="slideshow"></div>

    <button class="btn" onclick="authorizeSpotify()">Login with Spotify</button>

    <script>
      var slideIndex = 0;
      var slideshow = document.querySelector(".slideshow");
      var apiKey = "c0a95fb2065d724e02096da0d6a8331e";
      var tag = "focus";
      var requestUrl = `https://ws.audioscrobbler.com/2.0/?method=tag.gettopalbums&tag=${tag}&api_key=${apiKey}&format=json`;
      
      fetch(requestUrl)
        .then(response => response.json())
        .then(data => {
          var albums = data.topalbums.album;
          for (var i = 0; i < albums.length; i++) {
            var img = new Image();
            img.src = albums[i].image[2]["#text"];
            img.classList.add("slide");
            slideshow.appendChild(img);
          }
          showSlides();
        })
        .catch(error => console.error(error));

      function showSlides() {
        var slides = document.getElementsByClassName("slide");
        for (var i = 0; i < slides.length; i++) {
          slides[i].classList.remove("active");
        }
        slideIndex++;
        if (slideIndex > slides.length) { slideIndex = 1; }
        slides[slideIndex - 1].classList.add("active");
        setTimeout(showSlides, 3000); // Change image every 3 seconds
      }

      function authorizeSpotify() {
        var client_id = '88288336697c422d8f72b2f5f854e78e'; // Your client ID
        var redirect_uri = 'http://localhost:8000/callback.html'; // Your redirect URI
        var scopes = 'user-library-read'; // The scopes for the access token
        var url = 'https://accounts.spotify.com/authorize' +
          '?response_type=token' +
          '&client_id=' + encodeURIComponent(client_id) +
          '&scope=' + encodeURIComponent(scopes) +
          '&redirect_uri=' + encodeURIComponent(redirect_uri)  // Use Last FM API to get album art
      function searchAlbumArt(artist, album, callback) {
        var request = new XMLHttpRequest();
        request.open('GET', 'https://ws.audioscrobbler.com/2.0/?method=album.getinfo&api_key=' + lastFMAPIKey + '&artist=' + encodeURIComponent(artist) + '&album=' + encodeURIComponent(album) + '&format=json', true);

        request.onload = function() {
          if (request.status >= 200 && request.status < 400) {
            var data = JSON.parse(request.responseText);
            if (data.album && data.album.image && data.album.image.length > 0) {
              callback(data.album.image[data.album.image.length - 1]['#text']);
            }
          }
        };

        request.send();
      }

      // Update slideshow images with album art
      function updateAlbumArt() {
        var i;
        var slides = document.getElementsByClassName("slideshow")[0].getElementsByTagName("img");

        for (i = 0; i < albums.length; i++) {
          searchAlbumArt(albums[i].artist, albums[i].album, function(albumArtUrl) {
            var albumIndex = albums.findIndex(function(album) {
              return album.album === albumArtUrl.album && album.artist === albumArtUrl.artist;
            });

            if (albumIndex !== -1) {
              var slideIndex = albumIndex + 1;
              slides[slideIndex - 1].setAttribute("src", albumArtUrl);
            }
          });
        }
      }

      function authorizeSpotify() {
        var client_id = '88288336697c422d8f72b2f5f854e78e'; // Your client ID
        var redirect_uri = 'http://localhost:8000/callback.html'; // Your redirect URI
        var scopes = 'user-library-read'; // The scopes for the access token
        var url = 'https://accounts.spotify.com/authorize' +
          '?response_type=token' +
          '&client_id=' + encodeURIComponent(client_id) +
          '&scope=' + encodeURIComponent(scopes) +
          '&redirect_uri=' + encodeURIComponent(redirect_uri);

        window.location = url;
      }

      function getSavedAlbums(offset) {
        var request = new XMLHttpRequest();
        request.open('GET', 'https://api.spotify.com/v1/me/albums?limit=50&offset=' + offset, true);
        request.setRequestHeader('Authorization', 'Bearer ' + accessToken);

        request.onload = function() {
          if (request.status >= 200 && request.status < 400) {
            var data = JSON.parse(request.responseText);
            if (data.items && data.items.length > 0) {
              for (var i = 0; i < data.items.length; i++) {
                albums.push({
                  'artist': data.items[i].album.artists[0].name,
                  'album': data.items[i].album.name,
                });
              }
              getSavedAlbums(offset + 50);
            } else {
              updateAlbumArt();
            }
          }
        };

        request.send();
      }

      function getAccessToken() {
        var match = window.location.hash.match(/#access_token=(.*?)&/);
        if (match) {
          accessToken = match[1];
          getSavedAlbums(0);
        }
      }

      // Start the slideshow and check for access token
      showSlides();
      getAccessToken();
    </script>
  </body>
</html>
